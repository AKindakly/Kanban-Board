<!DOCTYPE html>
<html
    lang="en"
    x-data="kanbanBoard()"
    x-init="init()"
    xmlns:htmx="http://www.w3.org/1999/xhtml"
>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Kanban â€“ AlpineÂ +Â HTMX (multiâ€‘user)</title>

        <!-- Alpine.js -->
        <script
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
            defer
        ></script>
        <!-- htmx (for future backend calls) -->
        <script src="https://unpkg.com/htmx.org"></script>

        <style>
            .column {
                width: 30%;
                border: 1px solid #000;
                padding: 10px;
                min-height: 450px;
            }
            .task {
                padding: 10px;
                border: 1px solid gray;
                margin-bottom: 5px;
                background: #fff;
                cursor: move;
            }
            .isâ€‘done {
                opacity: 0.6;
                cursor: not-allowed;
            }
            .timestamp {
                font-size: 10px;
                color: gray;
                margin-top: 4px;
            }
            .badge {
                font-size: 12px;
                margin-top: 4px;
            }
        </style>
    </head>
    <body>
        <h2>JirooÂ RezeptÂ DailyÂ Board</h2>

        <div style="display: flex; gap: 20px">
            <template x-for="status in ['todo','doing','done']" :key="status">
                <div
                    class="column"
                    :id="status"
                    @dragover.prevent
                    @drop="dropTask($event, status)"
                >
                    <h3
                        x-text="status.charAt(0).toUpperCase()+status.slice(1)"
                    ></h3>

                    <template x-for="task in tasks[status]" :key="task.id">
                        <div
                            class="task"
                            :id="task.id"
                            :draggable="!task.done"
                            :class="task.done ? 'isâ€‘done' : ''"
                            @dragstart="dragTask(task)"
                            @click="toggleAssignment(task, status)"
                        >
                            <div x-text="task.text"></div>

                            <!-- render every user badge -->
                            <template x-for="u in task.userList" :key="u">
                                <div class="badge">
                                    ðŸ‘¤Â <span x-text="u"></span>
                                </div>
                            </template>

                            <!-- timestamp -->
                            <template x-if="task.doneAt">
                                <div
                                    class="timestamp"
                                    x-text="'DoneÂ at:Â '+task.doneAt"
                                ></div>
                            </template>
                        </div>
                    </template>
                </div>
            </template>
        </div>

        <script>
            function kanbanBoard() {
                return {
                    username: "Ayham", //  will come from Django later
                    draggedTask: null,

                    /* -------- sample data   --------------- */
                    tasks: {
                        todo: [
                            { id: "taskâ€‘1", text: "DHLÂ Labor" },
                            {
                                id: "taskâ€‘2",
                                text: "DHLÂ Defektur",
                                userList: ["Ayham"],
                            },
                            { id: "taskâ€‘3", text: "DHLÂ Mix" },
                            { id: "taskâ€‘6", text: "VIPs" },
                            { id: "taskâ€‘7", text: "SameDay" },
                        ],
                        doing: [
                            {
                                id: "taskâ€‘4",
                                text: "AbholungÂ Labor",
                                userList: ["Ayham"],
                            },
                            {
                                id: "taskâ€‘5",
                                text: "AbholungÂ Defektur",
                                userList: ["Ayham", "Franka"],
                            },
                        ],
                        done: [
                            {
                                id: "taskâ€‘6",
                                text: "AbholungÂ Mix",
                                userList: ["Ayham"],
                                doneAt: new Date().toLocaleString([], {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                    year: "numeric",
                                    month: "numeric",
                                    day: "numeric",
                                }),
                                done: true,
                            },
                        ],
                    },

                    /* ------------------- lifecycle hook (future fetch) --------------------- */
                    init() {
                        /* fetchTasks() could run here when backend ready */
                    },

                    /* ------------------- drag / drop logic --------------------------------- */
                    dragTask(task) {
                        if (!task.done) {
                            this.draggedTask = task;
                        }
                    },

                    dropTask(evt, target) {
                        if (!this.draggedTask) return;

                        /* confirm if going to DONE */
                        if (target === "done") {
                            if (
                                !confirm(
                                    "AreÂ youÂ sureÂ youÂ wantÂ toÂ markÂ thisÂ taskÂ asÂ done?"
                                )
                            ) {
                                this.draggedTask = null;
                                return;
                            }
                        }

                        /* remove from current column */
                        Object.keys(this.tasks).forEach((st) => {
                            this.tasks[st] = this.tasks[st].filter(
                                (t) => t.id !== this.draggedTask.id
                            );
                        });

                        /* set flags */
                        if (target === "done") {
                            this.draggedTask.doneAt = new Date().toLocaleString(
                                [],
                                {
                                    hour: "2-digit",
                                    minute: "2-digit",
                                    year: "numeric",
                                    month: "numeric",
                                    day: "numeric",
                                }
                            );
                            this.draggedTask.done = true;
                        } else {
                            this.draggedTask.doneAt = null;
                            this.draggedTask.done = false;
                        }

                        /* push into new column */
                        this.tasks[target].push(this.draggedTask);
                        this.draggedTask = null;
                    },

                    /* ------------------- assign / unassign current user -------------------- */
                    toggleAssignment(task, status) {
                        if (status === "done") return; // Locked

                        if (!task.userList) {
                            task.userList = [];
                        }

                        const idx = task.userList.indexOf(this.username);

                        if (idx !== -1) {
                            if (confirm("Remove yourself from this task?")) {
                                task.userList.splice(idx, 1);
                            }
                        } else {
                            task.userList.push(this.username);
                        }
                    },
                };
            }
        </script>
    </body>
</html>
